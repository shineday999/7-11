name: Send Kaohsiung Weather

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: {}

jobs:
  send_weather:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Kaohsiung weather
        id: fetch
        run: |
          WEATHER=$(curl -fsS 'https://wttr.in/Kaohsiung?format=3' || echo "無法取得天氣資訊")
          echo "weather<<EOF" >> $GITHUB_OUTPUT
          echo "$WEATHER" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram message
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WEATHER: ${{ steps.fetch.outputs.weather }}
        run: |
          if [ -z "${BOT_TOKEN}" ] || [ -z "${CHAT_ID}" ]; then
            echo "❌ Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID secrets" >&2
            exit 1
          fi
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="[高雄天氣] ${WEATHER}")
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "✅ Message sent successfully"
          else
            echo "❌ Telegram API error: $RESPONSE" >&2
            exit 1
          fi
